<tool id="soapdenovo2" name="SOAPdenovo2" version="2.04">
    <description></description>
    <requirements>
        <requirement type="package">soapdenovo2</requirement>
    </requirements>
    <command interpreter="python">
        soapdenovo2.py

        ## Reference source
        --file_source=$config_source.config_source_select
        #if $config_source.config_source_select == "history":
            ##Select configuration from history
            --configuration=$config_source.own_file
        #else:
            ## Create config file
            ## Parameters required in config file
            ## Maximum read length
            --max_read_length=$config_source.max_read_length

            #for $i in $config_source.libraries
                ##[LIB]
                ## Average insert size
                --avg_ins=$i.avg_ins
                ## Reverse sequence?
                --reverse_seq=$i.reverse_seq
                ## Read operations
                --asm_flags=$i.asm_flags
                ## Use only first 100 bps of each read
                --rd_len_cutoff=$i.rd_len_cutoff
                ## Rank
                --rank=$i.rank
                ## The cutoff of a pair number for a reliable connection (at least 3 for short insert size)
                --pair_num_cutoff=$i.pair_num_cutoff
                ## Minimum aligned length to contigs for a reliable read location (at least 32 for short insert size)
                --map_len=$i.map_len

                ## Check if using single or paired reads
                --type_of_data=$i.data_type.single_paired
                #if $i.data_type.single_paired == "single"
                    --format_of_data=$i.data_type.data_format.fastq_fasta
                    #if $i.data_type.data_format.fastq_fasta == "fastq"
                        --single_fastq_input1=$i.data_type.data_format.input1
                    #else if $i.data_type.data_format.fastq_fasta == "fastq_gzipped"
                        --single_fastq_gzipped_input1=$i.data_type.data_format.input1
                    #else if $i.data_type.data_format.fastq_fasta == "fasta"
                        --single_fasta_input1=$i.data_type.data_format.input1
                    #else if $i.data_type.data_format.fastq_fasta == "fasta_gzipped"
                        --single_fasta_gzipped_input1=$i.data_type.data_format.input1
                    #else
                        --single_bam_input1=$i.data_type.data_format.input1
                    #end if
                #else
                    --format_of_data=$i.data_type.data_format.fastq_fasta
                    #if $i.data_type.data_format.fastq_fasta == "fastq"
                        --paired_fastq_input1=$i.data_type.data_format.input1
                        --paired_fastq_input2=$i.data_type.data_format.input2
                    #else if $i.data_type.data_format.fastq_fasta == "fastq_gzipped"
                        --paired_fastq_gzipped_input1=$i.data_type.data_format.input1
                        --paired_fastq_gzipped_input2=$i.data_type.data_format.input2
                    #else if $i.data_type.data_format.fastq_fasta == "fasta"
                        --paired_fasta_input1=$i.data_type.data_format.input1
                        --paired_fasta_input2=$i.data_type.data_format.input2
                    #else if $i.data_type.data_format.fastq_fasta == "fasta_gzipped"
                        --paired_fasta_gzipped_input1=$i.data_type.data_format.input1
                        --paired_fasta_gzipped_input2=$i.data_type.data_format.input2
                    #else
                        --paired_bam_input1=$i.data_type.data_format.input1
                        --paired_bam_input2=$i.data_type.data_format.input2
                    #end if
                #end if
            #end for
        #end if

        ## Mandatory params
        --kmer_size=$kmer_size
        ## Commented out to keep control of thread number
        ##--ncpu=$ncpu
        --kmer_freq_cutoff=$kmer_freq_cutoff
        --resolve_repeats=$resolve_repeats
        --fill_gaps=$fill_gaps

        ## Check if using default or custom parameters
        --default_full_settings_type=$default_full_settings.settings_type
        #if $default_full_settings.settings_type == "full"
            --init_memory_assumption=$default_full_settings.init_memory_assumption
            --edge_cov_cutoff=$default_full_settings.edge_cov_cutoff
            --merge_level=$default_full_settings.merge_level
            --max_k=$default_full_settings.max_k
            --merge_clean_bubble=$default_full_settings.merge_clean_bubble
            --weight=$default_full_settings.weight
            ##--keep_avail_read=$default_full_settings.keep_avail_read
            ##--output_gap_related_reads=$default_full_settings.output_gap_related_reads
            --kmer_r2c=$default_full_settings.kmer_r2c
            --unmask_contigs=$default_full_settings.unmask_contigs
            --keep_contigs_connected=$default_full_settings.keep_contigs_connected
            --gap_len_diff=$default_full_settings.gap_len_diff
            --min_contig_len=$default_full_settings.min_contig_len
            --min_contig_cvg=$default_full_settings.min_contig_cvg
            --max_contig_cvg=$default_full_settings.max_contig_cvg
            --insert_size_upper_bound=$default_full_settings.insert_size_upper_bound
            --bubble_coverage=$default_full_settings.bubble_coverage
            --genome_size=$default_full_settings.genome_size
            --ass_visual=$default_full_settings.ass_visual
        #end if

        ## Output files
        --contig=$contig
        --scafseq=$scafseq
        --config=$config

    </command>
    <inputs>
        <conditional name="config_source">
        <param name="config_source_select" type="select" label="Select a configuration file from history or create a new one?">
            <option value="history">Use one from history</option>
            <option value="create">Create new configuration file</option>
        </param>
        <when value="history">
            <param name="own_file" type="data" metadata_name="dbkey" label="Select configuration file from history" />
        </when>
        <when value="create">
            <param name="max_read_length"
                   type="integer"
                   format="input"
                   label="Maximum read length"
                   value="90"/>
            <repeat name="libraries" title="libraries" min="1">
                <!-- [LIB] -->
                <param name="avg_ins"
                       type="integer"
                       label="Average insert size"
                       value="200"/>
                <param name="reverse_seq"
                       type="select"
                       label="Reverse sequence?"
                       value="0">
                    <option value="0">forward-reverse</option>
                    <option value="1">reverse-forward</option>
                </param>
                <param name="asm_flags"
                       type="select"
                       label="Which operations should the reads be used for?"
                       value="3">
                    <option value="3">For contig and scaffold assembly</option>
                    <option value="1">For only contig assembly</option>
                    <option value="2">For only scaffold assembly</option>
                </param>
                <param name="rd_len_cutoff"
                       type="integer"
                       label="Input the length of base pairs to use from reads"
                       value="100"/>
                <param name="rank"
                       type="integer"
                       label="Which order are the reads used while scaffolding"
                       value="1"/>
                <param name="pair_num_cutoff"
                       type="integer"
                       label="Pair number cutoff for a reliable connection"
                       value="3"/>
                <param name="map_len"
                       type="integer"
                       label="Length of contig that has to be aligned for a reliable read location"
                       value="32"/>
                <!-- Actual sequence data - can be single or paired reads -->
                <conditional name="data_type">
                    <param name="single_paired"
                           type="select"
                           label="What type of data are you using?">
                        <option value="paired">Paired</option>
                        <option value="single">Single</option>
                    </param>
                    <when value="paired">
                        <conditional name="data_format">
                            <param name="fastq_fasta"
                                   type="select"
                                   label="What is the format of your sequence data?">
                                <option value="fastq">FASTQ</option>
                                <option value="fastq_gzipped">FASTQ_GZIPPED</option>
                                <option value="fasta">FASTA</option>
                                <option value="fasta_gzipped">FASTA_GZIPPED</option>
                                <option value="bam">BAM</option>
                            </param>
                            <when value="fastq">
                                <param name="input1"
                                       type="data"
                                       format="input"
                                       label="Forward FASTQ file">
                                </param>
                                <param name="input2"
                                       type="data"
                                       format="input"
                                       label="Reverse FASTQ file">
                                </param>
                            </when>
                            <when value="fastq_gzipped">
                                <param name="input1"
                                       type="data"
                                       format="input"
                                       label="Forward FASTQ Gzipped file">
                                </param>
                                <param name="input2"
                                       type="data"
                                       format="input"
                                       label="Reverse FASTQ Gzipped file">
                                </param>
                            </when>
                            <when value="fasta">
                                <param name="input1"
                                       type="data"
                                       format="input"
                                       label="Forward FASTA file">
                                </param>
                                <param name="input2"
                                       type="data"
                                       format="input"
                                       label="Reverse FASTA file">
                                </param>
                            </when>
                            <when value="fasta_gzipped">
                                <param name="input1"
                                       type="data"
                                       format="input"
                                       label="Forward FASTA Gzipped file">
                                </param>
                                <param name="input2"
                                       type="data"
                                       format="input"
                                       label="Reverse FASTA Gzipped file">
                                </param>
                            </when>
                            <when value="bam">
                                <param name="input1"
                                       type="data"
                                       format="input"
                                       label="Forward BAM file">
                                </param>
                                <param name="input2"
                                       type="data"
                                       format="input"
                                       label="Reverse BAM file">
                                </param>
                            </when>
                        </conditional>
                    </when>
                    <when value="single">
                        <conditional name="data_format">
                            <param name="fastq_fasta"
                                   type="select"
                                   label="What type of data are you using?">
                                <option value="fastq">FASTQ</option>
                                <option value="fastq_gzipped">FASTQ_GZIPPED</option>
                                <option value="fasta">FASTA</option>
                                <option value="fasta_gzipped">FASTA_GZIPPED</option>
                                <option value="bam">BAM</option>
                            </param>
                            <when value="fastq">
                                <param name="input1"
                                       type="data"
                                       format="input"
                                       label="Forward FASTQ file">
                                </param>
                            </when>
                            <when value="fastq_gzipped">
                                <param name="input1"
                                       type="data"
                                       format="input"
                                       label="Forward FASTQ Gzipped file">
                                </param>
                            </when>
                            <when value="fasta">
                                <param name="input1"
                                       type="data"
                                       format="input"
                                       label="Forward FASTA file">
                                </param>
                            </when>
                            <when value="fasta_gzipped">
                                <param name="input1"
                                       type="data"
                                       format="input"
                                       label="Forward FASTA Gzipped file">
                                </param>
                            </when>
                            <when value="bam">
                                <param name="input1"
                                       type="data"
                                       format="input"
                                       label="Forward BAM file">
                                </param>
                            </when>
                        </conditional>
                    </when>
                </conditional>
            </repeat>
        </when>
        </conditional>
        <!-- Mandatory parameters -->
        <param name="kmer_size"
               type="integer"
               value="23"
               label="k-value in kmer"
               min="13"
               max="127"/>
        <!-- Commented out to keep control of thread number -->
        <!--<param name="ncpu"-->
               <!--type="integer"-->
               <!--value="2"-->
               <!--label="Number of CPUs"/>-->
        <param name="kmer_freq_cutoff"
               type="integer"
               value="0"
               label="Delete kmers with frequency no larger than?"/>
        <param name="resolve_repeats"
               type="select"
               value="NO"
               label="Resolve repeats by reads">
            <option value="NO">No</option>
            <option value="YES">Yes</option>
        </param>
        <param name="fill_gaps"
               type="select"
               label="Fill gaps in scaffold?">
            <option value="NO">No</option>
            <option value="YES">Yes</option>
        </param>

        <conditional name="default_full_settings">
        <param name="settings_type"
               type="select"
               label="SOAP settings to use"
               help="Default settings is suitable for most mapping needs. If you want full control, use Full parameter list">
            <option value="default">Default</option>
            <option value="full">Full parameter list</option>
        </param>
        <when value="default"/>
        <when value="full">
        <param name="init_memory_assumption"
               type="integer"
               label="Initiate memory assumption to avoid further reallocation, unit G"
                value="0"/>
        <param name="edge_cov_cutoff"
               type="integer"
               value="1"
               label="Delete edges with coverage no larger than?"/>
        <param name="merge_level"
               type="select"
               value="1"
               label="Strength of merging similar sequences during contig process">
            <option value="1">1</option>
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="0">0</option>
        </param>
        <param name="max_k"
               type="integer"
               value="1"
               label="Max k when using multi-kmer"
               help="This value should be an odd number and set higher than the kmer size."/>
        <param name="weight"
               type="integer"
               value="0"
               label="Weight to filter arc when linearizing two edges"/>
        <!--
        <param name="keep_avail_read"
               type="text"
               optional="true"
               label="Keep available read (*.read)"/>
        -->

        <param name="merge_clean_bubble"
               type="text"
               optional="true"
               label="Merge clean bubble before iterate"/>
	<!--
        <param name="output_gap_related_reads"
               type="select"
               value="NO"
               optional="true"
               label="Output gap related reads in map step for using SRkgf to fill gap">
            <option value="NO">No</option>
            <option value="YES">Yes</option>
        </param>
	-->
        <param name="kmer_r2c"
               type="integer"
               value="23"
               min="13"
               max="63"
               label="kmer size for mapping reads to contigs">
        </param>
        <param name="unmask_contigs"
               type="select"
               value="mask"
               optional="true"
               label="Unmask contigs with high/low coverage before scaffolding?">
            <option value="mask">Mask</option>
            <option value="unmask">Unmask</option>
        </param>
        <param name="keep_contigs_connected"
               type="select"
               value="NO"
               label="Keep contigs weakly connected to other contigs in scaffold?">
        <option value="NO">No</option>
        <option value="YES">Yes</option>
        </param>
        <param name="gap_len_diff"
               type="integer"
               value="50"
               label="Allowed length difference between estimated and filled gaps"/>
        <param name="min_contig_len"
               type="integer"
               value="20"
               label="Shortest contig length for scaffolding"/>
        <param name="min_contig_cvg"
               type="float"
               value="0.1"
               label="Minimum contig coverage (c*avgCvg)"
               help="Contigs shorter than 100bp with coverage smaller than c*avgCvg will be masked before scaffolding unless -u is set"/>
        <param name="max_contig_cvg"
               type="float"
               value="2"
               label="Maximum contig coverage (C*avgCvg)"
               help="Contigs with coverage larger than C*avgCvg or contigs shorter than 100bp with coverage larger than 0.8*C*avgCvg will be masked before scaffolding unless -u is set"/>
        <param name="insert_size_upper_bound"
               type="float"
               value="1.5"
               label="insertSizeUpperBound"
               help="Will be used as upper bound of insert size for large insert size ( > 1000) when handling pair-end connections between contigs if b is set to larger than 1"/>
        <param name="bubble_coverage"
               type="float"
               value="0.6"
               label="Bubble coverage"
               help="Remove contig with lower coverage in bubble structure if both contigs' coverage are smaller than bubbleCoverage*avgCvg"/>
        <param name="genome_size"
               type="integer"
               value="0"
               label="Genome size"
               help="Genome size for statistics"/>
        <param name="ass_visual"
               type="select"
               value="NO"
               optional="true"
               label="Output visualization information of assembly">
            <option value="NO">No</option>
            <option value="YES">Yes</option>
        </param>
        </when>
        </conditional>
    </inputs>
    <outputs>
        <!-- Provide 2 files as output from SOAPdenovo2 -->
        <data name="contig"
              type="data"
              format="txt"
              label="SOAPdvo2: Contigs">
        </data>
        <data name="scafseq"
              type="data"
              format="txt"
              label="SOAPdvo2: Scaffolds">
        </data>
        <!-- Provide config file in case its required for GapCloser -->
        <data name="config"
              type="data"
              format="txt"
              label="SOAPdvo2: CONFIG">
        </data>
    </outputs>
    <tests>
        <test>
            <param name="max_read_length"
                   value="50"/>
            <output name="contig"
                    value="hello world"/>
        </test>
    </tests>
    <help>
**What it does**

SOAPdenovo2 is a short-read assembly method for building de novo draft
assemblies of human-sized genomes. It is specially designed to assemble short
reads from the Illumina Genome Analyzer (GA).

This genome assembler is designed for assembling large plant and animal genomes,
although it also works well on bacteria and fungal genomes. The code runs on
64-bit and 32-bit Linux and MacOSX systems with a minimum of 5GB physical
memory. Approximately 150 GB of memory is required to process large genomes such
as  those of humans.

This Galaxy tool is a wrapping of SOAPdenovo version 2.04 which can process
kmers of up to 127 in size to process long reads. SOAPdenovo2 differs from
version 1 since:

1. The 63mer and 127mer executables have been merged.

2. Creation of the sparse-pregraph module for reducing computational
   consumption.

3. The Multi-kmer method has been introduced in the "contig" step to allow the
   utilization of small and large kmers.

4. The scaffolding algorithm can now obtain longer and more accurate scaffolds.

5. Asynchronous Input/Output is available to improve the performance of reading
   files.

6. Information for visualization purposes has been made available after
   scaffolding.

-----

**Configuration of SOAPdenovo2**

For large genome projects involving deep sequencing, data is usually organized
as a series of read sequence files generated from multiple libraries. Since
the pregraph step is the start of the SOAPdenovo2 pipeline, it requires a
configuration file to inform the SOAPdenovo2 assembler where to find these
files and about other relevant information required for the de novo assembly
process. This configuration file is automatically generated for SOAPdenovo2 by
setting parameters on this Galaxy tool page so the information below is provided
for reference or if you would like to write the configuration file by hand.

The actual configuration file begins with a section for global information.
Currently, only the maximum read length parameter, max_rd_len, is required in
the global information section. Any reads longer than max_rd_len will be cut to
this length.

Information about the sequencing data is then organized in the corresponding
library sections. Each library section starts with a [LIB] tag and includes the
following parameters::

  avg_ins           Indicates the average insert size of this library or the
                    peak value position in the insert size distribution.

  reverse_seq       A value which tells the assembler if the read  sequences
                    need to be complementarily reversed. Illumima GA produces
                    two types of paired-end libraries: a) forward-reverse,
                    generated from fragmented DNA ends with a typical insert
                    size less than 500 bp; b) forward-forward, generated  from
                    circularizing libraries with typical insert size greater
                    than 2 Kb. The reverse_seq parameter should be set to
                    indicate this: 0, forward-reverse; 1, forward-forward.

  asm_flags         Indicates which part(s) of the reads are used. A value of 1
                    for only contig assembly, 2 for only scaffold assembly, 3
                    for both contig and scaffold assembly, and 4 for only gap
                    closure.

  rd_len_cutof      The assembler will cut reads from the current library to
                    this length.

  rank              Sets an integer value to decide the order for reads to be
                    used for scaffold assembly. Libraries with the same rank
                    are used at the same time during scaffold assembly.

  pair_num_cutoff   The cutoff value for pair number for a reliable connection
                    between two contigs or pre-scaffolds. The minimum number for
                    paired-end reads and mate-pair reads is 3 and 5,
                    respectively.

  map_len           This parameter is used in the "map" step and is the minimum
                    alignment length between a read and a contig required for a
                    reliable read location. The minimum length for paired-end
                    reads and mate-pair reads is 32 and 35, respectively.

The assembler accepts read files in FASTA, FASTQ and BAM formats.

Mate-pair relationship can be indicated in two ways: two sequence files with
reads in the same order belonging to a pair, or two adjacent reads in a single
file (FASTA only) belonging to a pair. If a read in a BAM file fails platform
and vendor quality checks, e.g. the flag field 0x0200 is set, itself and it's
paired read will be ignored.

Single end files are indicated by "f=/path/filename" or "q=/path/filename" for
fasta or fastq formats separately. Paired reads in two fasta sequence files are
indicated by "f1=" and "f2=", whilst paired reads in two fastq sequence files
are indicated by "q1=" and "q2=". Paired reads in a single fasta sequence file
is indicated by a "p=" item. Reads in BAM sequence files is indicated by "b=".

All of the above items in each library section are optional since the assembler
assigns default values for most of them.

-----

**Outputs**

Two files are generated by SOAPdenovo2:

1. The contig file contains sequences without mate pair information.
2. The scafSeq file contains scaffold portions of the genome which have been
   reconstructed from contigs and gaps.

-----

**FAQ**

*How do I set the K-mer size?*

The program accepts odd numbers between 13 and 31. Larger K-mers will have a
higher rate of uniqueness in the genome and make the graph simpler, but it
requires deep sequencing depth and longer read length to guarantee the overlap
at any genomic location.

*How do I set the library rank?*

SOAPdenovo2 will use the pair-end libraries with insert size from smaller to
larger to construct scaffolds. Libraries with the same rank will be used at
the same time. For example, in a data set of a human genome, we set five ranks
for five libraries with insert size 200-bp, 500-bp, 2-Kb, 5-Kb and 10-Kb,
separately. It is desired that the pairs in each rank provide adequate physical
coverage of the genome.

-----

**More information**

For test data and more detailed information, click here_.

.. _here: http://soap.genomics.org.cn/soapdenovo.html


    </help>
</tool>
